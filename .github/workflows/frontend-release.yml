name: Release Frontend

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Setup Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3Ô∏è‚É£ Install deps
      - name: Install dependencies
        run: npm ci

      # 4Ô∏è‚É£ Build Angular
      - name: Build Angular
        run: npm run build -- --configuration=production

      # 5Ô∏è‚É£ Docker login
      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 6Ô∏è‚É£ Build Docker image (temporary tag)
      - name: Build Docker image
        run: |
          docker build \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/lista-compra-frontend:${{ github.sha }} \
            .

      # 7Ô∏è‚É£ Push Docker image (temporary)
      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/lista-compra-frontend:${{ github.sha }}

      # 8Ô∏è‚É£ Bump version (ONLY AFTER DOCKER PUSH)
      - name: Bump version
        run: |
          npm version patch --no-git-tag-version
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      # 9Ô∏è‚É£ Retag image with version + latest
      - name: Retag Docker image
        run: |
          docker tag \
            ${{ secrets.DOCKERHUB_USERNAME }}/lista-compra-frontend:${{ github.sha }} \
            ${{ secrets.DOCKERHUB_USERNAME }}/lista-compra-frontend:$VERSION

          docker tag \
            ${{ secrets.DOCKERHUB_USERNAME }}/lista-compra-frontend:${{ github.sha }} \
            ${{ secrets.DOCKERHUB_USERNAME }}/lista-compra-frontend:latest

      # üîü Push final tags
      - name: Push versioned tags
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/lista-compra-frontend:$VERSION
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/lista-compra-frontend:latest

      # 1Ô∏è‚É£1Ô∏è‚É£ Commit + tag
      - name: Commit and tag version
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add package.json package-lock.json
          git commit -m "chore(release): v$VERSION"
          git tag v$VERSION
          git push origin main --tags
