<div class="iniciar-compra-container">
  <app-loading-spinner *ngIf="loading"></app-loading-spinner>

  <ng-container *ngIf="!loading">
    <!-- Header -->
    <div class="page-header">
      <div class="header-content">
        <h2>{{ list.nome }}</h2>
        <p class="subtitle">
          <mat-icon>shopping_cart</mat-icon>
          {{ checkedCount }} de {{ items.length }} itens no carrinho
        </p>
      </div>
      <button mat-icon-button (click)="router.navigate(['/home'])">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Content -->
    <div class="page-content">
      <div class="items-list" *ngIf="items.length > 0; else noItems">
        <mat-card
          *ngFor="let item of items"
          [class.checked]="item.checked"
          class="item-card"
        >
          <div class="item-layout">
            <!-- Checkbox -->
            <div class="item-main-row">
              <mat-checkbox
                [checked]="item.checked"
                (change)="toggleCheck(item)"
                color="primary"
                class="item-checkbox"
              >
              </mat-checkbox>
              <h3 [class.strikethrough]="item.checked">{{ item.name }}</h3>
            </div>

            <div class="item-details">
              <!-- Header do item -->
              <div class="item-header">
                <div class="item-info">
                  <div class="quantity-controls">
                    <button
                      mat-icon-button
                      (click)="updateQuantity(item, -1)"
                      [disabled]="item.quantidade <= 1"
                      class="qty-button"
                    >
                      <mat-icon>remove</mat-icon>
                    </button>
                    <span class="quantity"
                      >{{ item.quantidade }} {{ item.unit }}</span
                    >
                    <button
                      mat-icon-button
                      (click)="updateQuantity(item, 1)"
                      class="qty-button"
                    >
                      <mat-icon>add</mat-icon>
                    </button>
                  </div>
                  <!-- Badge de promoção -->
                  <mat-chip
                    [highlighted]="item.onSale"
                    (click)="toggleSale(item)"
                    class="sale-chip"
                  >
                    <mat-icon matChipAvatar>local_offer</mat-icon>
                    {{ item.onSale ? "Em Promoção" : "Marcar Promoção" }}
                  </mat-chip>
                </div>
              </div>

              <!-- Seção de preços -->
              <div class="price-section">
                <!-- Preço estimado -->
                <div class="price-row">
                  <span class="label">Preço estimado:</span>
                  <span [class.line-through]="item.onSale" class="price">
                    R$ {{ item.priceEstimated.toFixed(2) }}
                  </span>
                </div>

                <!-- Campo de preço promocional -->
                <mat-form-field
                  *ngIf="item.onSale"
                  appearance="outline"
                  class="price-input"
                >
                  <mat-label>Preço na promoção</mat-label>
                  <span matPrefix>R$&nbsp;</span>
                  <input
                    matInput
                    type="number"
                    step="0.01"
                    min="0"
                    [value]="item.priceActual"
                    (input)="updatePrice(item, $any($event.target).value)"
                  />
                </mat-form-field>

                <mat-divider></mat-divider>

                <!-- Subtotal -->
                <div class="subtotal-row">
                  <span class="label">Subtotal:</span>
                  <div class="subtotal-value">
                    <strong>R$ {{ getItemSubtotal(item).toFixed(2) }}</strong>
                    <p *ngIf="getItemSavings(item) > 0" class="savings-text">
                      <mat-icon>savings</mat-icon>
                      Economizou R$ {{ getItemSavings(item).toFixed(2) }}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </mat-card>
      </div>

      <ng-template #noItems>
        <div class="empty-state">
          <mat-icon>remove_shopping_cart</mat-icon>
          <h2>Lista de compras vazia</h2>
          <p>Adicione itens à sua lista antes de iniciar uma compra.</p>
        </div>
      </ng-template>
    </div>

    <!-- Footer -->
    <div class="page-footer">
      <div class="footer-content">
      <div class="totals-summary">
        <p>
          Total ({{ checkedCount }} itens):
          <strong>R$ {{ total.toFixed(2) }}</strong>
        </p>
        <p *ngIf="savings > 0" class="savings-total">
          Economia total: <strong>R$ {{ savings.toFixed(2) }}</strong>
        </p>
      </div>
      <button
        mat-raised-button
        color="primary"
        (click)="finishShopping()"
        [disabled]="checkedCount === 0"
        class="finish-button"
      >
        Finalizar Compra
      </button>
    </div>
    </div>
  </ng-container>
</div>
